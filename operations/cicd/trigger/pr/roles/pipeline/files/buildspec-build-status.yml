version: 0.2
env:
  shell: bash
phases:
  build:
    commands:
      - printenv
      - SHA=$(cat .git/HEAD); echo SHA = "$SHA"
      - PIPELINE_ID=$(aws codepipeline get-pipeline-state --name ${CODEBUILD_INITIATOR#codepipeline/} --query 'stageStates[?actionStates[?latestExecution.externalExecutionId==`'${CODEBUILD_BUILD_ID}'`]].latestExecution.pipelineExecutionId' --output text); echo PIPELINE_ID = "$PIPELINE_ID"
      - BUILD_EXECUTION_ID=$(aws codepipeline list-action-executions --pipeline-name=Gradle-CICD-PR-Pipeline --filter="pipelineExecutionId=$PIPELINE_ID" --query 'actionExecutionDetails[?actionName==`Build`].output.executionResult.externalExecutionId' --output text); echo BUILD_EXECUTION_ID = "$BUILD_EXECUTION_ID"
      - REPORT_ARN=$(aws codebuild batch-get-builds --ids "$BUILD_EXECUTION_ID" --query 'builds[0].reportArns[0]' --output text); echo REPORT_ARN = "$REPORT_ARN"
      - ACCOUNT=$(echo $REPORT_ARN | cut -d":" -f5); echo ACCOUNT = "$ACCOUNT"
      - REPORT_GROUP=$(echo $REPORT_ARN | cut -d":" -f6 | cut -d"/" -f2); echo "$REPORT_GROUP"
      - REPORT_GROUP_ID=$(echo $REPORT_ARN | cut -d":" -f7); echo "$REPORT_GROUP_ID"
      - URL=https://console.aws.amazon.com/codesuite/codebuild/$ACCOUNT/testReports/reports/$REPORT_GROUP/$REPORT_GROUP:$REPORT_GROUP_ID; echo "$URL"
      - |
        curl --location --request POST 'https://api.github.com/repos/romanastr/base-gradle-cicd/statuses/'"$SHA" \
         --header 'Content-Type: application/x-www-form-urlencoded' \
         -u 'romanastr:'"$GITHUB_TOKEN" \
         --data-raw '{
           "state": "success",
           "target_url": "'"$URL"'",
           "description": "The unit tests passed",
           "context": "pr-unit-tests"
         }'